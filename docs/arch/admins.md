[В начало](../index.md)
---

# Администраторы

## Описание

Сущность определяет пользователей, с группами, 
правами в группах, которые имеют доступ в админ панель.

## Структура

### Таблицы

* App\Models\Admins - таблица хранящая данные пользователя
* App\Models\Role - таблица хранящая роли
* App\Models\Permission - таблица хранящая права доступа
* App\Models\PermissionGroup - таблица хранящая группы прав

### Миграции

* 2017_11_20_165143_create_admins_table.php - App\Models\Admins
* 2017_11_22_152739_create_roles_table.php - App\Models\Role
* 2017_11_22_145500_create_permissions_table.php - App\Models\Permission
* 2017_11_22_142714_create_permission_groups_table.php - App\Models\PermissionGroup

### Связи

* Роль к администратору (M2M) - 2017_11_23_154003_create_role_admins_table.php
* Роль к пермишену (M2M) - 2017_11_22_164941_create_role_permissions_table.php

### Контроллеры

* Backend/Users/Admins/AdminController - CRUD администратора
* Backend/Users/Admins/AdminProfileController - смена мыла, имени, пароля в профиле
* Backend/Users/Admins/RoleController - CRUD ролей

### Form requests

* Backend/UserAdminRequest

### Вьюхи

* backend/users/admins/index.blade.php - Главная страница администора.
* backend/users/admins/form.blade.php - Форма для создания, редактирования администратора.
* backend/users/admins/list.blade.php - Список для таблицы.
* backend/users/admins/item.blade.php - Строка таблицы.
* backend/users/admins/profile.blade.php - Страница редактирования профиля.

### Core

* Http/Middleware/AdminMiddleware.php - контроль доступа в админку, где требуется авторизация админа  
* Http/Middleware/AdminPermissionMiddleware.php - проверка доступа к конкретному разделу по пермишену 
* Guard - admins

### Реализация

#### Ограничение доступа

Для ограничения доступа в админку, в роутах используется AdminMiddleware через параметр middleware

```php
Route::group(['prefix' => 'admin', 'middleware' => 'adminMiddleware:admins'], function () {
 //
});
```
Ограничение доступа к какому-либо разделу по пермишену.  Например для ограничения 
доступа по префиксу `users/admins` делаем таким образом.


```php
Route::group(['prefix' => 'users/admins', 'middleware' => 'adminPermissionMiddleware:manage_admins'], function () {
    Route::get('/', 'Backend\Users\Admins\AdminController@index')->name('admin.users.admins');
});
```
**Важно:** эти ограничения должны быть внутри middleware - adminMiddleware

```php
// префикс /admin  с доступом только авторизованного администратора
Route::group(['prefix' => 'admin', 'middleware' => 'adminMiddleware:admins'], function () {
    
    // допуск в раздел /admin/users/admins пользователей у которых есть пермишен manage_admins
    Route::group(['prefix' => 'users/admins', 'middleware' => 'adminPermissionMiddleware:manage_admins'], function () {
        Route::get('/', 'Backend\Users\Admins\AdminController@index')->name('admin.users.admins');
    });
    
});
```

#### Права доступа

**Группы прав**

Все права объединяются в группы для удобства. Создание групп прав и самих пермишенов реализуется через Seed-ы:

* PermissionGroupTableSeeder.php - сид для групп прав
* PermissionTableSeeder.php - сид для самих пермишенов

Объединение прав в группы происходит просто по релевантности самих прав.

Чтобы создать группу прав, необходимо внести данные в сид PermissionGroupTableSeeder. Например, у нас стоит 
задача реализовать несколько справочников - (магазины, продавцы). Логично, что группу прав мы назовем справочники. 

В сиде PermissionGroupTableSeeder по умолчанию есть одна группа под названием "Пользователи" в которую входят некоторые пермишены 
и войдут созданные позже так или иначе связанные с управлением пользователями (Администраторами, Пользователями сайта и пр.)

В методе сида есть массив с группами под названием `$groups` который выглядит следующим образом:

```php
 $groups = [
        [
            'id' => 1, // айди записи в таблице
            'owner' => 'admin', // овнер
            'name' => 'Пользователи' // название группы
        ],
    ];
```

Чтобы добавить новую группу под названием "справочники" нужно модифицировать массив следующим образом:

```php
 $groups = [
    [
        'id' => 1, // айди записи в таблице
        'owner' => 'admin', // овнер
        'name' => 'Пользователи' // название группы
    ],
        
    [
        'id' => 2, // айди записи в таблице
        'owner' => 'admin', // овнер
        'name' => 'Справочники' // название группы
    ],
];
```

**Описание полей**

* id порядковый номер заданный именно руками. Это очень важно.
* owner - овнер. Это обусловлено тем, что мы можем задавать группы прав 
как для администраторов, так и для других пользователей, которые будут созданны позже.
* name - собственно название группы прав

После того, как мы добавили необходимые группы прав, 
мы можем запустить выполнение сида командой `php artisan db:seed `. При этом таблица группы прав будет очищена и заполненна заново. 
Говоря иначе, если вы захотите переименовать, или добавить новые группы, это делается безболезненно, так как мы руками задаем айди.

**Права**

Права, как и группы прав, задаются через сид PermissionTableSeeder. 
Сид с правами, также как и сид с группами прав имеет дефолтный массив с правами следующего вида:

```php
$permissions = [
    [
        'id' => 1,
        'owner' => 'admin',
        'group_id' => 1,
        'alias' => 'manage_admins',
        'name' => 'Управление делами1',
        'desc' => 'Позволяет создавать администраторов и назначать им роли'
    ],

];
```

Для того, чтобы добавить два пермишена для управления справочниками из 
примера выше, нам нужно модифицировать массив следующим образом.

```php
$permissions = [
    [
        'id' => 1,
        'owner' => 'admin',
        'group_id' => 1,
        'alias' => 'manage_admins',
        'name' => 'Управление администраторами',
        'desc' => 'Позволяет создавать администраторов и назначать им роли'
    ],
    
    [
        'id' => 2,
        'owner' => 'admin',
        'group_id' => 2,
        'alias' => 'catalogs_shops',
        'name' => 'Справочник магазинов',
        'desc' => 'Позволяет создавать/редактировать магазины в справочнике'
    ],
    
    [
        'id' => 3,
        'owner' => 'admin',
        'group_id' => 2,
        'alias' => 'catalogs_sellers',
        'name' => 'Справочник продавцов',
        'desc' => 'Позволяет создавать/редактировать продавцов в справочнике'
    ],

];
```

**Описание полей**

* id - порядковый номер, аналогичный из сида групп прав
* owner - поле аналогично полю из сида групп прав
* group_id - тут мы указываем айди группы, которую мы создали выше
* alias - это как раз то, что мы передаем в качестве параметра в роутере для adminPermissionMiddleware
* name - Краткое название пермишена
* desc - описание пермишена. Тут должно быть емкое название, чтобы администратор 
назначая пермишен в роль имел представление к чему он дает доступ

После добавления пермишена, нужно запустить сид на исполнение командой `php artisan db:seed `

Таблица пермишенов будет очищена и записана заново.

**Предостережение**

Нужно иметь ввиду, что в таблице связывающей роль и пермишен указан айди созданного пермишена. 
И если вы планируете удалить из сида какой-либо пермишен, то и из связующей таблицы нужно его также удалить.

#### TODO & Improvements

**Оптимизация создания групп прав и пермишенов**

* Администратору добавить флаг developer и сделать спец раздел, в который имеют доступ только пользователи с флагом developper.
* В спец разделе сделать инфтерфейс для создания/редактирования групп прав и самих прав.
* Для удобства переноса данных с локальной машины на прод или тестовую среду - предусмотреть автоматический дампинг/восстановление создаваемых/редактируемых через спец раздел данных.
* В консольной команде создания администратора спрашивать о том, нужно ли назначить создаваемого администратора как developper

**Кэширование прав**

* При назначении администратору роли или нескольких ролей нужно консолидировать права с этих ролей и закешировать в файл.
* Далее, при проверке наличия конкретного пермишена у конкретного пользователя (В AdminPermissionMiddleware.php) данные брать с файла.
